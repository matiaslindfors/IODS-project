---
title: "chapter6"
author: "Matias Lindfors"
date: "7 joulukuuta 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Matias Lindfors, 7.12.2018
#This is the analysis exercise for week 6:

# Let's start by loading the two datasets that were created in the wrangling phase:

BPRSL <- read.table("file:///C:/Users/matia/Desktop/GitHub/IODS-project/BPRSL")
RATSL <- read.table("file:///C:/Users/matia/Desktop/GitHub/IODS-project/RATSL")

# 1) Lets now get to implementing the analyses of Chapter 8 of MABS, using the RATS(L) data:

library(dplyr)
library(tidyr)
library(ggplot2)

#(Had to re-convert the following variables to factors to make the subsequent code work, for some reason, despite having done it in the wrangling exercise?)

BPRSL$treatment <- factor(BPRSL$treatment)
BPRSL$subject <- factor(BPRSL$subject)

RATSL$ID <- factor(RATSL$ID)
RATSL$Group <- factor(RATSL$Group)

ggplot(RATSL, aes(x = Time, y = rats, linetype = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=4)) +
  facet_grid(. ~ Group, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = c(min(RATSL$rats), max(RATSL$rats)))

#The graphs produced here demonstrate considerable differences in the rats' weight (g) between the three groups, as well as a marked tracking effect, in which the subjects whose weight is high initially tend to have a higher weight at the end of the period of investigation as well.

#The phenomenon of tracking, described above, is more readily observable when we plot the standardized values of each observation, so let's:

RATSL <- RATSL %>%
  group_by(Time) %>%
  mutate(stdrats = (rats - mean(rats))/sd(rats) ) %>%
  ungroup()

ggplot(RATSL, aes(x = Time, y = stdrats, linetype = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=4)) +
  facet_grid(. ~ Group, labeller = label_both) +
  scale_y_continuous(name = "standardized rats")

#This is marvelously demonstrative! Although there seems to be an overall tracking effect, some individual subjects seem to be deviating from this trend. Let's move on to examining average profiles:

n <- RATSL$Time %>% unique() %>% length()

RATSS <- RATSL %>%
  group_by(Group, Time) %>%
  summarise( mean = mean(rats), se = sd(rats)/sqrt(n) ) %>%
  ungroup()

ggplot(RATSS, aes(x = Time, y = mean, linetype = Group, shape = Group)) +
  geom_line() +
  scale_linetype_manual(values = c(1,2,3)) +
  geom_point(size=3) +
  scale_shape_manual(values = c(1,2,3)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, linetype="1"), width=0.3) +
  theme(legend.position = c(0.8,0.8)) +
  scale_y_continuous(name = "mean(rats) +/- se(rats)")

#This seems quite a bit more clear to view, and is thus more informative! No apparent overlapping in the average profiles is observed.

#Moving on, let's produce side-by-side boxplots:

RATSL8S <- RATSL %>%
  filter(Time > 0) %>%
  group_by(Group, ID) %>%
  summarise( mean=mean(rats) ) %>%
  ungroup()

ggplot(RATSL8S, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(rats), Time 1-50")

# 2) Lets now get to implementing the analyses of Chapter 9 of MABS, using the BPRS(L) data:

#Starting with a basic plot of the data:

ggplot(BPRSL, aes(x = week, y = bprs, group = subject)) +
  geom_line()

#As is apparrent, the plot looks rather "messy" and is of little use. Let's move on to create a regression model:

BPRS_reg <- lm(bprs ~ week + treatment, data = BPRSL)
summary(BPRS_reg)

#As we can see, in this model, the variable "week" is significant but the "treatment" variable is not.

#Let's now create a random intercept model, using the variable "subject" as a random effect:

library(lme4)

BPRS_ref <- lmer(bprs ~ week + treatment + (1 | subject), data = BPRSL, REML = FALSE)
summary(BPRS_ref)

#Moving on, let's create a random intercept and random slope model:

BPRS_ref1 <- lmer(bprs ~ week + treatment + (week | subject), data = BPRSL, REML = FALSE)
summary(BPRS_ref1)

#Let's perform an ANOVA on the two models:

anova(BPRS_ref1, BPRS_ref)

#The p-value of 0.026 suggests a good fit against the comparison model.

#To top this all off, let's now create a random intercept and random slope model with interaction:

BPRS_ref2 <- lmer(bprs ~ week * treatment + (week | subject), data = BPRSL, REML = FALSE)
summary(BPRS_ref2)

#ANOVA:

anova(BPRS_ref2, BPRS_ref1)

#A p-value of 0.07 is observed. Creating a vector of fitted values:

Fitted <- fitted(BPRS_ref2)

#Creating a new column (Fitted) to BPRSL:

BPRSL <- BPRSL %>%
  mutate(Fitted)

#Plotting BPRSL:

ggplot(BPRSL, aes(x = week, y = Fitted, group = subject)) +
  geom_line(aes(linetype = "treatment")) +
  scale_x_continuous(name = "Time (weeks)", breaks = seq(0, 10, 3)) +
  scale_y_continuous(name = "Fitted bprs") +
  theme(legend.position = "top")

#Well, the graph suggests that bprs declines over time.

#THE END.

```
